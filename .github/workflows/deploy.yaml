name: Deploy Frontend (GHCR)

on:
  push:
    branches: [develop, homolog, main]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY:  ${{ secrets.SSH_PRIVATE_KEY }}

      INFRA_PATH: /home/jony/freelaverse/infra

      # GHCR
      GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}

      IMAGE_NAME: freelaverse-web

    steps:
      - name: Detect branch → profile/tag/envfile
        id: vars
        shell: bash
        run: |
          set -e
          BRANCH="${GITHUB_REF##*/}"

          if [ "$BRANCH" = "develop" ]; then
            PROFILE="dev"
            TAG="dev"
            ENVFILE=".env.dev"
          elif [ "$BRANCH" = "homolog" ]; then
            PROFILE="hml"
            TAG="hml"
            ENVFILE=".env.hml"
          elif [ "$BRANCH" = "main" ]; then
            PROFILE="prod"
            TAG="prod"
            ENVFILE=".env.prod"
          else
            echo "Branch inválida: $BRANCH"
            exit 1
          fi

          echo "profile=$PROFILE" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "envfile=$ENVFILE" >> "$GITHUB_OUTPUT"

      - name: Checkout frontend
        uses: actions/checkout@v4

      - name: Lowercase owner (GHCR exige)
        id: owner
        shell: bash
        run: |
          echo "lower=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login GHCR (push)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ steps.owner.outputs.lower }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy on VPS (pull + up)
        shell: bash
        run: |
          set -e

          mkdir -p ~/.ssh
          echo "${SSH_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          PROFILE="${{ steps.vars.outputs.profile }}"
          ENVFILE="${{ steps.vars.outputs.envfile }}"
          OWNER="${{ steps.owner.outputs.lower }}"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${{ steps.vars.outputs.tag }}"

          ssh -i ~/.ssh/id_ed25519 \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=120 \
            -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" << EOF
              set -e

              echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${GHCR_USERNAME}" --password-stdin

              cd "${INFRA_PATH}"

              docker compose --profile "${PROFILE}" --env-file "${ENVFILE}" pull "web_${PROFILE}"
              docker compose --profile "${PROFILE}" --env-file "${ENVFILE}" up -d --no-deps "web_${PROFILE}"

              docker compose --profile "${PROFILE}" ps "web_${PROFILE}"
          EOF
