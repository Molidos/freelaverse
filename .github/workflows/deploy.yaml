name: Deploy Frontend

on:
  push:
    branches: [develop, homolog, main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY:  ${{ secrets.SSH_PRIVATE_KEY }}

      # caminho do repo do FRONT na VPS
      FRONT_REPO_PATH: /home/jony/freelaverse/frontend

      # caminho do infra (compose/nginx/envs) na VPS
      INFRA_PATH: /home/jony/freelaverse/infra

    steps:
      - name: Detect branch
        id: vars
        shell: bash
        run: |
          set -e
          BRANCH="${GITHUB_REF##*/}"

          if [ "$BRANCH" = "develop" ]; then
            PROFILE="dev"
            ENVFILE=".env.dev"
          elif [ "$BRANCH" = "homolog" ]; then
            PROFILE="hml"
            ENVFILE=".env.hml"
          elif [ "$BRANCH" = "main" ]; then
            PROFILE="prod"
            ENVFILE=".env.prod"
          else
            echo "Branch invÃ¡lida: $BRANCH"
            exit 1
          fi

          echo "branch=$BRANCH"  >> "$GITHUB_OUTPUT"
          echo "profile=$PROFILE" >> "$GITHUB_OUTPUT"
          echo "envfile=$ENVFILE" >> "$GITHUB_OUTPUT"

      - name: Deploy (git pull frontend + docker compose)
        shell: bash
        run: |
          set -e

          mkdir -p ~/.ssh
          echo "${SSH_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          BRANCH="${{ steps.vars.outputs.branch }}"
          PROFILE="${{ steps.vars.outputs.profile }}"
          ENVFILE="${{ steps.vars.outputs.envfile }}"

          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" << EOF
            set -e

            # Atualiza FRONTEND (repo separado)
            cd "${FRONT_REPO_PATH}"
            git fetch --all
            git checkout "${BRANCH}"
            git pull origin "${BRANCH}"

            # Sobe o ambiente via compose (infra separado)
            cd "${INFRA_PATH}"
            docker compose -f docker-compose.yaml --profile "${PROFILE}" --env-file "${ENVFILE}" up --no-deps -d --build "web_${PROFILE}"

            docker compose -f docker-compose.yaml --profile "${PROFILE}" ps "web_${PROFILE}"
          EOF
